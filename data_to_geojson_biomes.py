import numpy as np
from skimage import measure
from shapely.geometry import Polygon, mapping
import json

# Suppose `biome_data` is a 2D numpy array of shape (7680, 7680)
# Each element is a biome label (int or str)

example_chunk = {
    "chunk_x": 120,
    "chunk_z": 202,
    "biomes": [11,11,11,11,11,11,11,11,267,267,267,267,267,2817,2817,2817,2817,2817,1,1,1,1,1,1,1,1,1,1,1,1,1,1,11,11,11,11,11,11,11,11,267,267,267,267,267,2817,2817,2817,2817,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,11,11,11,11,11,11,11,11,267,267,267,267,267,2817,2817,2817,2817,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,11,11,11,11,11,11,11,11,267,267,267,267,267,2817,2817,2817,2817,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,11,11,11,11,11,11,11,11,267,267,267,267,267,2817,2817,2817,2817,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,11,11,11,11,11,11,11,11,267,267,267,267,267,2817,2817,2817,2817,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,11,11,11,11,11,11,11,11,267,267,267,267,267,2817,2817,2817,2817,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,11,11,11,11,11,11,11,11,267,267,267,267,267,2817,2817,2817,2817,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,11,11,11,11,11,11,11,11,267,267,267,267,267,2817,2817,2817,2817,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,11,11,11,11,11,11,11,11,267,267,267,267,267,2817,2817,2817,2817,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,11,11,11,11,11,11,11,11,267,267,267,267,267,2817,2817,2817,2817,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,11,11,11,11,11,11,11,11,267,267,267,267,267,2817,2817,2817,2817,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,11,11,11,11,11,11,11,11,267,267,267,267,267,2817,2817,2817,2817,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,11,11,11,11,11,11,11,267,267,267,267,267,267,2817,2817,2817,2817,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,11,11,11,11,11,11,11,267,267,267,267,267,267,2817,2817,2817,2817,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,11,11,11,11,11,11,267,267,267,267,267,2817,2817,2817,2817,2817,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,11,11,11,11,11,11,11,267,267,267,267,267,2817,2817,2817,2817,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,11,11,11,11,11,267,267,267,267,267,267,2817,2817,2817,2817,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,11,11,11,11,267,267,267,267,267,267,267,267,2817,2817,2817,2817,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,11,11,11,267,267,267,267,267,267,267,2817,2817,2817,2817,2817,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,11,11,11,267,267,267,267,267,267,267,2817,2817,2817,2817,2817,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,11,11,267,267,267,267,267,267,267,267,2817,2817,2817,2817,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,11,267,267,267,267,267,267,267,2817,2817,2817,2817,2817,2817,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,267,267,267,267,267,267,2817,2817,2817,2817,2817,2817,2817,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,267,267,267,267,267,267,267,2817,2817,2817,2817,2817,2817,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,267,267,267,267,267,267,2817,2817,2817,2817,2817,2817,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,267,267,267,267,267,2817,2817,2817,2817,2817,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,267,267,267,2817,2817,2817,2817,2817,2817,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,267,267,267,2817,2817,2817,2817,2817,2817,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,267,267,267,2817,2817,2817,2817,2817,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,267,2817,2817,2817,2817,2817,2817,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2817,2817,2817,2817,2817,2817,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
}

chunk_32_32 = [example_chunk['biomes'][i*32:(i+1)*32] for i in range(32)]


print(chunk_32_32)


biome_data = np.array(chunk_32_32)

print(biome_data)



padded = np.pad(biome_data, pad_width=1, mode='constant', constant_values=-1)

geojson_features = []


for biome_type in np.unique(padded):
    mask = (padded == biome_type)
    labeled, num = measure.label(mask, connectivity=1, return_num=True)
    contours = measure.find_contours(mask, level=0.5)

    for region_label in range(1, num + 1):
        region_mask = (labeled == region_label)
        contours = measure.find_contours(region_mask, level=0.5)

        for contour in contours:
            coords = [(float(x)-0.6, float(y)-0.6) for y, x in contour]

            polygon = Polygon(coords)

            feature = {
                "type": "Feature",
                "properties": {"biome": str(biome_type)},
                "geometry": mapping(polygon)
            }

            geojson_features.append(feature)

with open("biomes.geojson", "w") as f:
    json.dump(geojson_features, f)